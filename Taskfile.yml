version: "3"

vars:
  VERSION:
    sh: git describe --tags --exact-match 2>/dev/null || echo "v0.0.0"
  COMMIT_COUNT:
    sh: git rev-list --count HEAD

tasks:
  clean:
    desc: Clean build artifacts
    deps: ['clean:bin', 'clean:version-info']

  clean:bin:
    desc: Clean build directory
    cmds:
      - rm -rf bin/*
    status:
      - test -z "$(find bin -maxdepth 1 -type f -print -quit)"

  clean:version-info:
    desc: Clean autogenerated version info
    dir: cmd/p86l
    cmds:
      - rm -f versioninfo.json
      - rm -f app.manifest
      - rm -f resource.syso
    sources:
      - versioninfo.json
      - app.manifest
      - resource.syso
    status:
      - test ! -f versioninfo.json
      - test ! -f app.manifest
      - test ! -f resource.syso

  clean:build-artifacts:
    desc: Clean build artifacts but keep zips
    dir: bin
    cmds:
      - rm -f Project-86-Launcher.exe icon.ico icon.png
      - rm -rf Project-86-Launcher

  run:
    cmds:
      - go run cmd/p86l/main.go

  build:
    desc: Build all release artifacts
    cmds:
      - task: build:windows
      - task: package:zip
      - task: package:checksum
      - task: clean:build-artifacts

  build:debug:
    cmds:
      - go build -ldflags "-s -w" -trimpath -o bin/ cmd/p86l/main.go

  build:windows:
    cmds:
      - GOOS=windows GOARCH=amd64 go build -ldflags "-s -w -X main.VERSION={{.VERSION}} -X=runtime.godebugDefault=asyncpreemptoff=1 -H=windowsgui" -trimpath -o bin/Project-86-Launcher.exe ./cmd/p86l
    generates:
      - bin/Project-86-Launcher.exe

  generate:version-info:
    desc: Generate versioninfo.json with proper version data
    cmds:
      - go install 
      - go run ./scripts/version.go {{default "v0.0.0" .VERSION}} {{.COMMIT_COUNT}}
      - go generate ./cmd/p86l
    sources:
      - scripts/version.go
      - .git/HEAD
      - .git/refs/tags/*
    generates:
      - cmd/p86l/versioninfo.json
      - cmd/p86l/app.manifest
      - cmd/p86l/resource.syso

  package:zip:
    desc: Create ZIP archives for Windows executables
    deps: ['package:zip-assets']
    dir: bin
    cmds:
      - |
        APP_DIR="Project-86-Launcher-{{.VERSION}}/Project-86-Launcher"
        mkdir -p "$APP_DIR"

        cp Project-86-Launcher.exe "$APP_DIR/"
        cp icon.ico "$APP_DIR/"
        cp icon.png "$APP_DIR/"

        zip -r "Project-86-Launcher-{{.VERSION}}.zip" "Project-86-Launcher-{{.VERSION}}"
        rm -rf "Project-86-Launcher-{{.VERSION}}"
    sources:
      - "Project-86-Launcher.exe"
      - "icon.ico"
      - "icon.png"
    generates:
      - "Project-86-Launcher-{{.VERSION}}.zip"

  package:zip-assets:
    desc: Copy assets needed for zip to bin directory
    cmds:
      - cp assets/images/icon.ico bin/
      - cp assets/images/icon.png bin/
    sources:
      - assets/icon.ico
      - assets/icon.png
    generates:
      - bin/icon.ico
      - bin/icon.png
    status:
      - test -f bin/icon.ico
      - test -f bin/icon.png

  package:checksum:
    desc: Generate SHA256 checksums for release files
    dir: bin
    cmds:
      - sha256sum Project-86-Launcher-{{.VERSION}}.zip Project-86-Launcher.exe icon.ico icon.png > sha256sum.txt
    sources:
      - "Project-86-Launcher-{{.VERSION}}.zip"
      - "Project-86-Launcher.exe"
      - "icon.ico"
      - "icon.png"
    generates:
      - sha256sum.txt
